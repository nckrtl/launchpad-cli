services:
  horizon:
    image: launchpad-php:8.4
    container_name: launchpad-horizon
    volumes:
      # Mount the web app
      - ../web:/app
      # Mount Docker socket for CLI commands
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount CLI binary
      - ${HOME}/.local/bin/launchpad:/usr/local/bin/launchpad:ro
      # Mount CLI config (needed for CLI commands)
      - ${HOME}/.config/launchpad:/home/launchpad/.config/launchpad
      # Mount projects directory (needed for provisioning)
      - ${HOME}/projects:/home/launchpad/projects
      # Mount host binaries needed by CLI
      - /usr/bin/gh:/usr/bin/gh:ro
      - /usr/bin/git:/usr/bin/git:ro
      - /usr/bin/node:/usr/bin/node:ro
      - /usr/bin/npm:/usr/bin/npm:ro
      - /usr/local/bin/composer:/usr/local/bin/composer:ro
      - ${HOME}/.bun/bin:/home/launchpad/.bun/bin:ro
      # SSH keys (needed for git clone via SSH)
      - ${HOME}/.ssh:/home/launchpad/.ssh:ro
      # GitHub CLI config - mount to XDG location used by FrankenPHP
      - ${HOME}/.config/gh:/config/gh:ro
    environment:
      - HOME=/home/launchpad
      - REDIS_HOST=launchpad-redis
      - REDIS_PORT=6379
      - REVERB_HOST=launchpad-reverb
      - REVERB_PORT=6001
      - REVERB_SCHEME=http
      - PATH=/home/launchpad/.bun/bin:/home/launchpad/.local/bin:/usr/local/bin:/usr/bin:/bin
    working_dir: /app
    command: php artisan horizon
    user: launchpad
    restart: unless-stopped
    networks:
      - launchpad
    healthcheck:
      test: ["CMD-SHELL", "php artisan horizon:status | grep -q running || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

networks:
  launchpad:
    external: true
